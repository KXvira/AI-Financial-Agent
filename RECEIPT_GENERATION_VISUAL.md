# Receipt Generation Module - Visual Architecture 🎨

## System Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         RECEIPT GENERATION SYSTEM                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 1: TRIGGER EVENTS                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐│
│  │ M-Pesa       │  │ Bank         │  │ Invoice      │  │ Manual      ││
│  │ Payment      │  │ Transfer     │  │ Payment      │  │ Request     ││
│  │ Completed    │  │ Confirmed    │  │ Marked Paid  │  │ Generated   ││
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬──────┘│
│         │                  │                  │                  │       │
│         └──────────────────┴──────────────────┴──────────────────┘       │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 2: DATA COLLECTION & VALIDATION                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ Collect Transaction Data                                          │ │
│  │  • Transaction ID                                                 │ │
│  │  • Amount & Currency (KES)                                        │ │
│  │  • Payment Method (M-Pesa/Bank/Cash)                             │ │
│  │  • M-Pesa Code (if applicable)                                   │ │
│  │  • Customer Information                                          │ │
│  │  • Invoice Reference (if applicable)                             │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ Validate Data                                                     │ │
│  │  ✓ Amount > 0                                                    │ │
│  │  ✓ Customer exists                                               │ │
│  │  ✓ Payment method valid                                          │ │
│  │  ✓ No duplicate receipt for transaction                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 3: RECEIPT NUMBER GENERATION                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ Sequential Number Logic                                           │ │
│  │                                                                   │ │
│  │  1. Check receipt_sequences collection                           │ │
│  │  2. Get last_number for current year                            │ │
│  │  3. Increment by 1 (atomic operation)                           │ │
│  │  4. Format: RCP-YYYY-#### (e.g., RCP-2025-0001)                │ │
│  │                                                                   │ │
│  │  Example:                                                        │ │
│  │    Year: 2025                                                    │ │
│  │    Last Number: 1234                                            │ │
│  │    New Number: 1235                                             │ │
│  │    Receipt Number: RCP-2025-1235                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 4: TAX CALCULATION (KRA Compliance)                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ VAT Calculation (16%)                                            │ │
│  │                                                                   │ │
│  │  Total Amount: KES 50,000.00                                     │ │
│  │                                                                   │ │
│  │  Calculation:                                                    │ │
│  │  Subtotal = Total / 1.16 = 43,103.45                           │ │
│  │  VAT (16%) = Subtotal × 0.16 = 6,896.55                        │ │
│  │  Total = Subtotal + VAT = 50,000.00                            │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │ Receipt Breakdown                                       │   │ │
│  │  │ Subtotal:      KES 43,103.45                           │   │ │
│  │  │ VAT (16%):     KES  6,896.55                           │   │ │
│  │  │ ─────────────────────────────                           │   │ │
│  │  │ Total:         KES 50,000.00                           │   │ │
│  │  └─────────────────────────────────────────────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 5: QR CODE GENERATION                                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ QR Code Data                                                      │ │
│  │                                                                   │ │
│  │  URL: https://verify.finguard.com/receipt/RCP-2025-0001         │ │
│  │                                                                   │ │
│  │  ┌─────────────────────┐                                        │ │
│  │  │ ▄▄▄▄▄▄▄  ▄  ▄▄▄▄▄▄▄ │  QR Code Image                        │ │
│  │  │ █ ▄▄▄ █ ▄█▄ █ ▄▄▄ █ │  Size: 200x200px                      │ │
│  │  │ █ ███ █ ▀▀▀ █ ███ █ │  Error Correction: M                  │ │
│  │  │ █▄▄▄▄▄█ ▄ █ █▄▄▄▄▄█ │  Encoding: UTF-8                      │ │
│  │  │▄▄▄▄▄ ▄▄▄▀█▄▄ ▄ ▄ ▄▄ │                                        │ │
│  │  │ ▀  ▀█▄▄ █ ▄▀█  ▄▀▄  │                                        │ │
│  │  │▄▄▄▄▄▄▄ █▄██ ▄▄▄▄▄▄▄ │                                        │ │
│  │  │ ▄▄▄ █  ▀ ▄  █ ▄▄▄ █ │                                        │ │
│  │  │ ███ █ ▄█▀▄▄ █ ███ █ │                                        │ │
│  │  │ ▄▄▄▄▄ █▀  ▀▀█▄▄▄▄▄█ │                                        │ │
│  │  └─────────────────────┘                                        │ │
│  │                                                                   │ │
│  │  Saved as: /qr_codes/RCP-2025-0001.png                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 6: PDF GENERATION (ReportLab)                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ PDF Layout (A4 Portrait)                                         │ │
│  │ ┌─────────────────────────────────────────────────────────────┐ │ │
│  │ │ ┌──────────────────┐        RECEIPT                        │ │ │
│  │ │ │                  │     RCP-2025-0001                      │ │ │
│  │ │ │   [LOGO]         │                              [QR CODE] │ │ │
│  │ │ │                  │     January 12, 2025                   │ │ │
│  │ │ └──────────────────┘     14:30:00 EAT                       │ │ │
│  │ │                                                              │ │ │
│  │ │ ───────────────────────────────────────────────────────────  │ │ │
│  │ │                                                              │ │ │
│  │ │ FROM (PAYER)                 TO (RECIPIENT)                 │ │ │
│  │ │ Tech Solutions Ltd            Fin Guard Systems             │ │ │
│  │ │ KRA PIN: P051234567A         KRA PIN: P051234567B          │ │ │
│  │ │ info@techsolutions.com       accounts@finguard.com          │ │ │
│  │ │ +254 712 345 678             +254 700 000 000              │ │ │
│  │ │ Westlands, Nairobi           CBD, Nairobi, Kenya           │ │ │
│  │ │                                                              │ │ │
│  │ │ ───────────────────────────────────────────────────────────  │ │ │
│  │ │                                                              │ │ │
│  │ │ PAYMENT DETAILS                                             │ │ │
│  │ │ Payment Method: M-Pesa                                      │ │ │
│  │ │ M-Pesa Code: RK12ABC345                                    │ │ │
│  │ │ Invoice Reference: INV-2025-0045                           │ │ │
│  │ │ Description: Payment for Invoice INV-2025-0045              │ │ │
│  │ │                                                              │ │ │
│  │ │ ───────────────────────────────────────────────────────────  │ │ │
│  │ │                                                              │ │ │
│  │ │ AMOUNT BREAKDOWN                                            │ │ │
│  │ │                                                              │ │ │
│  │ │ Subtotal:                               KES 43,103.45       │ │ │
│  │ │ VAT (16%):                              KES  6,896.55       │ │ │
│  │ │ ─────────────────────────────────────────────────────────   │ │ │
│  │ │ TOTAL PAID:                             KES 50,000.00       │ │ │
│  │ │                                                              │ │ │
│  │ │ ───────────────────────────────────────────────────────────  │ │ │
│  │ │                                                              │ │ │
│  │ │ NOTES                                                       │ │ │
│  │ │ Thank you for your payment. This receipt is computer        │ │ │
│  │ │ generated and does not require a signature.                 │ │ │
│  │ │                                                              │ │ │
│  │ │ ───────────────────────────────────────────────────────────  │ │ │
│  │ │                                                              │ │ │
│  │ │ For inquiries: accounts@finguard.com | +254 700 000 000    │ │ │
│  │ │ Scan QR code to verify: [QR CODE]                          │ │ │
│  │ └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  Saved as: /receipts/2025/01/RCP-2025-0001.pdf                  │ │
│  │  File Size: 145 KB                                               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 7: DATABASE STORAGE                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ MongoDB: receipts Collection                                      │ │
│  │                                                                   │ │
│  │  {                                                                │ │
│  │    "_id": ObjectId("..."),                                       │ │
│  │    "receipt_id": "RCP-2025-0001",                                │ │
│  │    "type": "payment",                                            │ │
│  │    "transaction_id": "txn_12345",                                │ │
│  │    "invoice_id": "INV-2025-0045",                                │ │
│  │    "amount": 50000.00,                                           │ │
│  │    "currency": "KES",                                            │ │
│  │    "payment_method": "mpesa",                                    │ │
│  │    "mpesa_code": "RK12ABC345",                                   │ │
│  │    "from": { ... },                                              │ │
│  │    "to": { ... },                                                │ │
│  │    "pdf_path": "/receipts/2025/01/RCP-2025-0001.pdf",           │ │
│  │    "pdf_url": "https://...",                                     │ │
│  │    "qr_code_path": "/qr_codes/RCP-2025-0001.png",               │ │
│  │    "status": "generated",                                        │ │
│  │    "sent_via_email": true,                                       │ │
│  │    "created_at": ISODate("2025-01-12T14:30:00Z")                │ │
│  │  }                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 8: EMAIL DELIVERY (Optional)                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ Email Content                                                     │ │
│  │                                                                   │ │
│  │  To: info@techsolutions.com                                      │ │
│  │  Subject: Payment Receipt - RCP-2025-0001                        │ │
│  │                                                                   │ │
│  │  ┌────────────────────────────────────────────────────────────┐ │ │
│  │  │ Dear Tech Solutions Ltd,                                   │ │ │
│  │  │                                                             │ │ │
│  │  │ Thank you for your payment of KES 50,000.00.               │ │ │
│  │  │                                                             │ │ │
│  │  │ Your receipt number is: RCP-2025-0001                      │ │ │
│  │  │ Payment Method: M-Pesa (RK12ABC345)                        │ │ │
│  │  │ Date: January 12, 2025                                     │ │ │
│  │  │                                                             │ │ │
│  │  │ Please find your receipt attached as a PDF.                │ │ │
│  │  │                                                             │ │ │
│  │  │ [Download Receipt Button]                                  │ │ │
│  │  │                                                             │ │ │
│  │  │ For any questions, contact us at:                          │ │ │
│  │  │ accounts@finguard.com | +254 700 000 000                   │ │ │
│  │  │                                                             │ │ │
│  │  │ Best regards,                                              │ │ │
│  │  │ Fin Guard Systems                                          │ │ │
│  │  └────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  Attachment: RCP-2025-0001.pdf (145 KB)                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 9: AUDIT LOGGING                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ Receipt Audit Log                                                 │ │
│  │                                                                   │ │
│  │  Event: generated                                                │ │
│  │  Timestamp: 2025-01-12 14:30:00                                  │ │
│  │  User: system                                                    │ │
│  │  IP: 192.168.1.100                                               │ │
│  │  Details: Auto-generated from M-Pesa payment                     │ │
│  │                                                                   │ │
│  │  Event: emailed                                                  │ │
│  │  Timestamp: 2025-01-12 14:30:05                                  │ │
│  │  User: system                                                    │ │
│  │  To: info@techsolutions.com                                      │ │
│  │  Status: delivered                                               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 10: RESPONSE & NOTIFICATION                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ API Response (JSON)                                               │ │
│  │                                                                   │ │
│  │  {                                                                │ │
│  │    "success": true,                                              │ │
│  │    "receipt_id": "RCP-2025-0001",                                │ │
│  │    "receipt_number": "RCP-2025-0001",                            │ │
│  │    "amount": 50000.00,                                           │ │
│  │    "currency": "KES",                                            │ │
│  │    "pdf_url": "https://api.../receipts/RCP-2025-0001/download", │ │
│  │    "qr_code_url": "https://verify.../receipt/RCP-2025-0001",    │ │
│  │    "email_sent": true,                                           │ │
│  │    "created_at": "2025-01-12T14:30:00Z",                         │ │
│  │    "message": "Receipt generated and sent successfully"          │ │
│  │  }                                                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ Customer Notification                                             │ │
│  │                                                                   │ │
│  │  ✅ Receipt generated                                            │ │
│  │  ✅ PDF created and stored                                       │ │
│  │  ✅ Email sent to customer                                       │ │
│  │  ✅ SMS notification (optional)                                  │ │
│  │  ✅ Dashboard updated                                            │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                              PROCESS COMPLETE
═══════════════════════════════════════════════════════════════════════════

Time Elapsed: ~2 seconds
Files Created: 3 (PDF, QR Code PNG, Database Document)
Notifications Sent: 1 Email + 1 SMS (optional)
Audit Logs: 2 entries (generated, emailed)
Status: ✅ SUCCESS
```

---

## Integration Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────┐
│                        SYSTEM INTEGRATIONS                            │
└──────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│   M-Pesa    │
│   Gateway   │◄──────┐
└─────────────┘       │
                      │
┌─────────────┐       │        ┌────────────────────────────────────┐
│   Invoice   │       │        │                                    │
│   System    │◄──────┼────────│   Receipt Generation Service       │
└─────────────┘       │        │                                    │
                      │        │  • Validate Transaction            │
┌─────────────┐       │        │  • Generate Receipt Number         │
│   Payment   │       │        │  • Calculate VAT                   │
│   System    │◄──────┤        │  • Create PDF with QR Code         │
└─────────────┘       │        │  • Store in Database               │
                      │        │  • Send Email                      │
┌─────────────┐       │        │  • Log Audit Trail                 │
│   Customer  │       │        │                                    │
│   System    │◄──────┘        └───────────┬────────────────────────┘
└─────────────┘                            │
                                           │
              ┌────────────────────────────┼────────────────────────┐
              │                            │                        │
              ▼                            ▼                        ▼
    ┌─────────────────┐        ┌─────────────────┐      ┌─────────────────┐
    │   Email         │        │   Database      │      │   File          │
    │   Service       │        │   (MongoDB)     │      │   Storage       │
    │                 │        │                 │      │   (S3/Local)    │
    │  • Send Receipt │        │  • receipts     │      │  • PDFs         │
    │  • Send Summary │        │  • templates    │      │  • QR Codes     │
    │  • Attachments  │        │  • audit_logs   │      │  • Images       │
    └─────────────────┘        └─────────────────┘      └─────────────────┘
```

---

## Data Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────┐
│                         DATA FLOW                                     │
└──────────────────────────────────────────────────────────────────────┘

INPUT DATA                  PROCESSING                  OUTPUT DATA
─────────────              ────────────                ────────────

Transaction ID    ──────►  Fetch Transaction    ──────►  Receipt Metadata
Amount (KES)      ──────►  Validate Data        ──────►  PDF Document
Payment Method    ──────►  Generate Number      ──────►  QR Code Image
Customer ID       ──────►  Calculate VAT        ──────►  Email Message
Invoice ID        ──────►  Create PDF           ──────►  Audit Log Entry
                          Generate QR Code
                          Save to Database
                          Send Email
                          Log Activity

┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│  Raw         │         │  Validated   │         │  Formatted   │
│  Transaction │  ────►  │  Receipt     │  ────►  │  PDF Receipt │
│  Data        │         │  Data        │         │  + QR Code   │
└──────────────┘         └──────────────┘         └──────────────┘
```

---

## Component Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                    RECEIPT GENERATION COMPONENTS                      │
└──────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         Backend Layer                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ receipts/router.py                                             ││
│  │  • POST /receipts/generate                                     ││
│  │  • GET /receipts/{id}                                          ││
│  │  • GET /receipts/{id}/download                                 ││
│  │  • POST /receipts/{id}/email                                   ││
│  │  • GET /receipts (list)                                        ││
│  │  • POST /receipts/{id}/void                                    ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ receipts/service.py                                            ││
│  │  • validate_transaction()                                      ││
│  │  • generate_receipt_number()                                   ││
│  │  • calculate_vat()                                             ││
│  │  • create_receipt()                                            ││
│  │  • void_receipt()                                              ││
│  │  • get_receipt_statistics()                                    ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ receipts/pdf_generator.py                                      ││
│  │  • generate_pdf()                                              ││
│  │  • apply_template()                                            ││
│  │  • add_header()                                                ││
│  │  • add_body()                                                  ││
│  │  • add_footer()                                                ││
│  │  • add_qr_code()                                               ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ receipts/qr_generator.py                                       ││
│  │  • generate_qr_code()                                          ││
│  │  • create_verification_url()                                   ││
│  │  • save_qr_image()                                             ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ receipts/models.py                                             ││
│  │  • Receipt (Pydantic model)                                    ││
│  │  • ReceiptTemplate                                             ││
│  │  • ReceiptAuditLog                                             ││
│  └────────────────────────────────────────────────────────────────┘│
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         Frontend Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ app/receipts/page.tsx                                          ││
│  │  • Receipt list view                                           ││
│  │  • Search and filters                                          ││
│  │  • Bulk actions                                                ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ app/receipts/[id]/page.tsx                                     ││
│  │  • Receipt detail view                                         ││
│  │  • PDF viewer                                                  ││
│  │  • Download/Email actions                                      ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ components/ReceiptPDFViewer.tsx                                ││
│  │  • Embedded PDF display                                        ││
│  │  • Zoom controls                                               ││
│  │  • Print functionality                                         ││
│  └────────────────────────────────────────────────────────────────┘│
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │ components/GenerateReceiptModal.tsx                            ││
│  │  • Receipt generation form                                     ││
│  │  • Customer selection                                          ││
│  │  • Preview before generation                                   ││
│  └────────────────────────────────────────────────────────────────┘│
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         Database Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  receipts    │  │  templates   │  │  audit_logs  │            │
│  │  collection  │  │  collection  │  │  collection  │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

*This visual guide complements the detailed implementation plan in RECEIPT_GENERATION_MODULE_PLAN.md*
